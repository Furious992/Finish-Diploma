# Дипломная работа. Перцев Максим Андреевич

В рамках дипломного практикума мной была реализована облачная инфраструктура и настроен полный цикл работы с приложением: от развёртывания инфраструктуры до автоматической сборки и деплоя приложения в Kubernetes.

Целью работы было получить практический опыт работы с облачными технологиями, инфраструктурой как кодом, контейнеризацией, Kubernetes и CI/CD.

## 1. Создание облачной инфраструктуры

Для развёртывания инфраструктуры был выбран облачный провайдер **Yandex Cloud**.

Вся инфраструктура создаётся с помощью **Terraform**, без ручного создания ресурсов через веб-интерфейс.  
Terraform-конфигурация разбита на два этапа:

* > 00-bootstrap — создание сервисного аккаунта и Object Storage bucket для хранения terraform state.

* > 10-main — создание основной инфраструктуры:

  * сети VPC,
  * подсетей в разных зонах доступности,
  * managed Kubernetes кластера,
  * группы рабочих нод.

Terraform настроен так, что инфраструктура может быть полностью создана и удалена командами:
```bash
terraform apply
terraform destroy
```

Это позволяет легко пересоздавать инфраструктуру при необходимости.

Дополнительно для Terraform был настроен **CI pipeline в GitHub Actions**, который при каждом изменении кода выполняет:

 > * terraform fmt  
 > * terraform validate  
 > * terraform plan  

Это позволяет автоматически проверять корректность конфигурации.

Репозиторий с инфраструктурой:  
> https://github.com/Furious992/diploma-infra

----
## 2. Развёртывание Kubernetes кластера

После создания инфраструктуры был развёрнут **managed Kubernetes кластер** в Yandex Cloud.  

Кластер доступен извне, настроен доступ через kubeconfig.  
Для проверки работоспособности использовались команды:  

```bash
kubectl get nodes
kubectl get pods --all-namespaces
```

Все системные поды работают корректно, ноды находятся в статусе Ready.

----
## 3. Создание тестового приложения

В качестве тестового приложения был создан простой веб-сервис на базе **nginx**, который отдаёт статическую HTML-страницу.

Для приложения подготовлены:

 > * index.html — страница приложения,
 > * nginx.conf — конфигурация nginx,
 > * Dockerfile — сборка Docker-образа.

Docker-образ собирается и публикуется в **DockerHub**:  
> https://hub.docker.com/r/furious992/diploma-app

Репозиторий с приложением:  
> https://github.com/Furious992/diploma-app

----
## 4. Деплой приложения и мониторинг

Приложение было задеплоено в Kubernetes с помощью манифестов Deployment и Service.  
Service настроен как **LoadBalancer**, поэтому приложение доступно по внешнему IP:  

 * Тестовое приложение:
 > http://158.160.164.74

Для мониторинга кластера была установлена система **kube-prometheus-stack**, включающая:  

 * Prometheus,
 * Grafana,
 * Alertmanager,
 * node-exporter.

Grafana доступна по внешнему IP (**Предоставлю log/pass по запросу преподавателя**):  
 > http://158.160.223.63

В Grafana доступны дашборды, отображающие:  

 * состояние Kubernetes кластера,
 * нагрузку на ноды,
 * использование ресурсов.

Манифесты Kubernetes и описание установки мониторинга вынесены в отдельный репозиторий:  
> https://github.com/Furious992/diploma-k8s

----
## 5. Настройка CI/CD

Для приложения был настроен полноценный **CI/CD pipeline на GitHub Actions**.

Pipeline работает следующим образом:  

 * При коммите в ветку **main**:
   * собирается Docker-образ,
   * образ публикуется в DockerHub с тегом **latest**,
   * выполняется автоматический деплой новой версии в Kubernetes.
 * При создании тега (например **v1.0.0**):
   * собирается Docker-образ с соответствующим тегом,
   * образ публикуется в DockerHub,
   * в кластер деплоится версия с этим тегом.
Таким образом реализован полный цикл:  

> изменение кода → сборка → публикация → деплой → работающий сервис.

----
## 6. Итог работы

В результате выполнения дипломного практикума мной были освоены и применены на практике следующие технологии:  

 * Yandex Cloud
 * Terraform (Infrastructure as Code)
 * Kubernetes
 * Docker
 * Helm
 * Prometheus и Grafana
 * GitHub Actions (CI/CD)  

Была реализована полностью рабочая система, включающая:  

 * автоматизированную инфраструктуру,
 * Kubernetes кластер,
 * мониторинг,
 * контейнеризированное приложение,
 * автоматическую сборку и деплой.

----
## Основные трудности и как они были решены

В процессе выполнения дипломного практикума возникало несколько технических сложностей, которые пришлось решать по ходу работы.

#### 1. Проблемы с Terraform backend и переменными

На этапе настройки Terraform возникали ошибки, связанные с backend (S3) и отсутствием обязательных переменных, например **bucket_name**.  
Изначально pipeline GitHub Actions не проходил, потому что Terraform не получал значения переменных.  

Проблема была решена добавлением необходимых secrets в GitHub и передачей их в pipeline через временный **terraform.tfvars**.

#### 2. Ошибки доступа к Kubernetes из CI/CD

При настройке GitHub Actions для деплоя приложения возникала ошибка подключения к кластеру, связанная с тем, что в kubeconfig использовалась утилита **yc**, которая отсутствует в runner’е GitHub.  

Эта проблема была решена переходом на аутентификацию через ServiceAccount и передачу в pipeline:  

 * server,
 * CA сертификата,
 * токена доступа.

После этого деплой в Kubernetes стал работать стабильно.

#### 3. Проблемы с Git и репозиториями

Во время работы несколько раз возникали конфликты при push в репозитории (**rejected: fetch first**).  
Это происходило из-за того, что часть файлов редактировалась через GitHub web-интерфейс, а часть — локально.  

Решалось это с помощью:

 * > git pull --rebase
 * аккуратного разрешения конфликтов

В итоге была выработана привычка сначала синхронизировать репозиторий, а потом пушить изменения.

#### 4. CI/CD не проходил из-за неправильно заданных secrets

При первой настройке GitHub Actions пайплайн падал из-за неправильно заданных переменных и secrets.  

После проверки логов Actions и корректировки:  

 * DOCKERHUB_USERNAME
 * DOCKERHUB_TOKEN
 * K8S_SERVER
 * K8S_CA_B64
 * K8S_TOKEN

pipeline стал выполняться успешно.

#### 5. Ошибки провайдера Yandex Cloud

Terraform не мог создать ресурсы из-за:  

 * неправильно заданных cloud_id и folder_id
 * проблем с правами сервисного аккаунта
 * некорректных IAM ролей

Приходилось:  

 * проверять роли сервисного аккаунта,
 * сверять настройки через yc config list,
 * пересматривать Terraform-код.

Это показало, насколько важно правильно настраивать права доступа.

---
### Итог

Работа с Terraform и облачной инфраструктурой оказалась самой сложной частью проекта, но именно она дала наибольшее понимание того, как устроены реальные системы.

В процессе приходилось:

 * читать документацию,
 * разбираться с ошибками по логам,
 * экспериментировать с настройками.

Это дало ценный практический опыт работы с инфраструктурой и DevOps-инструментами.

## Заключение 

Во время выполнения работы я получил практический опыт построения инфраструктуры и DevOps-процессов с нуля.
Проект показал, как все этапы — инфраструктура, кластер, приложение, мониторинг и CI/CD — связаны между собой и работают как единая система.


## Полезные ресурсы, которые помогали в работе

В процессе выполнения диплома использовались официальные документации и открытые источники:

#### Terraform

Официальная документация Terraform:  
 > https://developer.hashicorp.com/terraform/docs

Документация по backend S3:  
 > https://developer.hashicorp.com/terraform/language/settings/backends/s3

Документация по переменным Terraform:  
 > https://developer.hashicorp.com/terraform/language/values/variables

#### Yandex Cloud

Документация Yandex Cloud по Terraform:  
 > https://cloud.yandex.ru/docs/tutorials/infrastructure-management/terraform-quickstart

Документация Managed Kubernetes:  
 > https://cloud.yandex.ru/docs/managed-kubernetes

Документация по IAM и сервисным аккаунтам:  
 > https://cloud.yandex.ru/docs/iam

#### Kubernetes

Официальная документация Kubernetes:  
 > https://kubernetes.io/docs/home/

kubectl cheatsheet:  
 > https://kubernetes.io/docs/reference/kubectl/cheatsheet/

#### CI/CD и GitHub Actions

Документация GitHub Actions:  
 > https://docs.github.com/en/actions

Примеры workflow для Docker:  
 > https://docs.github.com/en/actions/publishing-packages/publishing-docker-images
